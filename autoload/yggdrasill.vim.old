"yggdrasill vim plugin

let bash_jobs = []
let prompt_active = 0

func TextEntered(text)
	call ch_sendraw(g:bash_job,a:text .. "\n")
endfunc

func GotOutput(channel,msg)
	if a:channel == g:active_ch
		call appendbufline(g:buf,line("$",bufwinid(g:buf)) -1,"- " . a:msg)
	endif
endfunc

func JobExit(job,status)
	quit!
	let g:prompt_active = 0
endfunc

func Sigint()
	call job_stop(g:bash_job,"int")
endfunc

func PromptWindow()
	new
	set buftype=prompt
	set nonu
	let g:buf = bufnr('')
	call prompt_setcallback(g:buf,function("TextEntered"))
	call prompt_setprompt(g:buf,'command: ')
	call prompt_setinterrupt(g:buf,function("Sigint"))

	startinsert
endfunc

func yggdrasill#YggdrasillTerm(mods)
	let g:bash_job = job_start(["/bin/bash"],{"out_cb": function('GotOutput'),"err_cb": function('GotOutput'),"exit_cb": function('JobExit')})
	call add(g:bash_jobs,g:bash_job)
	let g:active_ch = job_getchannel(g:bash_job)

	if g:prompt_active == 0
		call PromptWindow()
		let g:prompt_active = 1
	endif

endfunc

func yggdrasill#TermChange()
	let g:bash_job = bash_jobs[0]
	let g:active_ch = job_getchannel(g:bash_job)
endfunc

"C言語のコンパイルを行う
func yggdrasill#CCompile(...)
	let l:fname=expand("%")
	if term_list() == []
		rightbelow term
	endif
	let l:opts=get(a:,1,"")
	let l:text="gcc " . l:fname . " " . l:opts . "\n"
	call term_sendkeys(term_list()[0],l:text)
endfunction
